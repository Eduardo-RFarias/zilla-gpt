<head>
  <meta charset="utf-8">
  <!-- Melhoria da visualização em smartphones -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- carrecargar recursos do material dessign -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!--Bootstrap -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.2/js/bootstrap.min.js" integrity="sha512-5BqtYqlWfJemW5+v+TZUs22uigI8tXeVah5S/1Z6qBLVO7gakAOtkOzUtgq6dsIo5c0NJdmGPs0H9I+2OHUHVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.2/css/bootstrap.min.css" integrity="sha512-CpIKUSyh9QX2+zSdfGP+eWLx23C8Dj9/XmHjZY2uDtfkdLGo0uY12jgcnkX9vXOgYajEKb/jiw67EYm+kBf+6g==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>

<!-- css -->
<link rel="stylesheet" href="css/index.css">

<body>
<!-- correção da margem -->
<div class="corpo">
<!-- pular linha -->
<br>

<h6><b>ZillaGPT</b></h6>

<!-- texto terminal -->
<div id="terminalContainer"></div>

</div> <!-- fim da div corpo -->

<!-- campo de input de texto -->
<div class="prompt-container">
<div style="margin-inline: 2em;margin-bottom: 1em;">
 <!-- botao enviar -->
 <button id="btnEnviar" class="btn btn-primary enviar">
  Enviar
 </button>
 <!-- input prompt -->
 <input class="form-control" type="text" id="formterminal">
</div>
</div>

</body>

<script type="module">
import openailib from 'https://cdn.jsdelivr.net/npm/openai@3.2.1/+esm';
//console.log("openailib: ",openailib);
let configuration;
let openai;
let loading = false;
const gptModelName = "gpt-3.5-turbo";
const personalidade = `
Você é a ZillaGPT, uma raposa assistente e prestativa.
`;

function initializeChat(behavior) {
  return [
    {role: "system", content: behavior}
  ];
}

async function completionsChatTextModelV3(messages) {
  const parameters ={
      model: gptModelName,
      messages: messages,
      /*
      temperature: ,
      max_tokens: ,
      top_p: ,
      frequency_penalty: ,
      presence_penalty: ,
      */
  };
  console.log("parameters: ",parameters);
  return await openai.createChatCompletion(parameters);
}

async function generateChatMessagesV3(promptText, messages) {
  const prompt = {role: "user", content: promptText};
  messages.push(prompt);

  const apiResponse = await completionsChatTextModelV3(messages);
  const textResponse = apiResponse.data.choices[0].message.content;

  const assistantResponse = {role: "assistant", content: textResponse};
  messages.push(assistantResponse);

  return messages;
}

function lastMessage(messages){
  return messages[messages.length - 1].content;
}

function key (){
  const cripto = "WXpKemRGRXhSbmhVZWtKR1RWaFZlV0p1UW5aWmFteDBUVmhGTVdJd1pGVk5NRXB6V1cxMFIxTnRlRWxOZW1jMVpGZHNWMDlIV2xWaE1qVk5aREZrYkU5VldsQT0=";
  const apiKey = atob(atob(atob(cripto)));
  return apiKey;
}

async function configurar(){
  configuration = new openailib.Configuration({
    apiKey: key(),
  });
  openai = new openailib.OpenAIApi(configuration);
  return initializeChat(personalidade);
}

function getPrompt(){
return document.getElementById("formterminal").value;
}

function appendChat(text){
  const terminal = document.getElementById("terminalContainer");
  let p = document.createElement("p");
  p.innerHTML = text;
  p.classList.add("terminal");
  terminal.appendChild(p);
}

function disableButton(){
  const btnEnviar = document.getElementById('btnEnviar');
  btnEnviar.disabled = true;
}

function enableButton(){
  const btnEnviar = document.getElementById('btnEnviar');
  btnEnviar.disabled = false;
}

function clearInput(){
  document.getElementById("formterminal").value = "";
}

let mensagesObject = await configurar();
const btnEnviar = document.getElementById('btnEnviar');
btnEnviar.addEventListener('click', async () => {
  const userInput = getPrompt();
  if (loading === false){
    loading = true;
    console.log("loading");
    disableButton();
    appendChat(userInput);
    mensagesObject = await generateChatMessagesV3(userInput,mensagesObject);
    loading = false;
    clearInput();
    enableButton();
    console.log("mensagesObject: ",mensagesObject);
    const textResponse = lastMessage(mensagesObject);
    console.log("textResponse: ",textResponse);
    appendChat(textResponse);
  }
});

</script>
